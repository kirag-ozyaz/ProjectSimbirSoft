(window.webpackJsonp=window.webpackJsonp||[]).push([[27],{1576:function(t,e,i){"use strict";i.r(e),i.d(e,"default",(function(){return W}));var s=i(10),n=i(0),o=i(5),r=i(7),a=i(13),d=i(41),l=i(69),h=i(20);class m{constructor(t){this.$dom={main:t,count:n.bem.find(t,"count"),preloader:null},this.is_root=n.bem.hasMod(this.$dom.main,"root"),this.ids=n.data(t,"ids").split(","),this.words=n.data(t,"words").split("|"),this.parent_id=n.data(t,"parent-id"),this.with_subtree="1"===n.data(t,"with-subtree")}setWait(t){this.is_root||!1===t||null!==this.$dom.preloader||(this.$dom.preloader=n.preloader(),n.append(this.$dom.main,this.$dom.preloader)),n.bem.toggle(this.$dom.main,"waiting",!1!==t)}getIds(){return this.ids}isWithSubtree(){return this.with_subtree}getParentId(){return this.parent_id}setCount(t){t>0?n.text(this.$dom.count,`${t} ${Object(l.a)(t,this.words)}`):n.remove(this.$dom.main)}substract(t){this.ids=Object(h.a)(this.ids,t)}destroy(){this.$dom=n.nullDom(this.$dom),this.ids=null,this.parent_id=null,this.with_subtree=null}}class c{constructor(){this.collection=new d.a({create:function(t){return new m(t)},destroy:function(t,e){e.destroy()}})}add(t){this.collection.addElement(t)}get(t){return this.collection.getByElement(t)}destroy(){this.collection.clear()}}var u=i(33);class _{constructor(t){this.elements={main:t.element,counter:n.bem.find(t.element,"counter")},this.handlers=t.handlers||{},this.items=[],this.items_buffer=new u.a({delay:500,onFlushEvery:this.add.bind(this)}),this.is_blocked=!1,this.is_active=!1,n.on(this.elements.main,"click",this.onClick.bind(this))}block(t){this.is_blocked=!1!==t}isBlocked(){return!0===this.is_blocked}onClick(){this.isBlocked()||this.remove(this.items[0])}delayedAdd(t){this.items_buffer.add(t)}add(t){this.items.indexOf(t)<0&&(this.items.push(t),this.updateCount(),void 0!==this.handlers.onAdd&&this.handlers.onAdd(t))}remove(t,e=!1){var i=this.items.indexOf(t);i>=0&&(this.items.splice(i,1),this.updateCount(),void 0!==this.handlers.onRemove&&this.handlers.onRemove(t,e))}activate(t){this.is_active=t,this.show(t)}show(t){n.bem.toggle(this.elements.main,"shown",t)}hide(){this.show(!1)}zero(t){n.bem.toggle(this.elements.main,"zero",t)}updateCount(){this.setCount(this.items.length)}setCount(t){n.text(this.elements.counter,t),this.zero(0===t)}destroy(){n.off(this.elements.main),this.items_buffer.destroy(),this.elements=n.nullDom(this.elements)}}var g=i(77),f=i(2),p=i(26),b=i(3);const v={};function y(t){const e=Math.round(999999999*Math.random())+"";return v[e]=t,e}class C{constructor(t){this.init(t)}init(t){this.id=t.id,this.author_id=t.author_id,this.diff_limit=t.diff_limit,this.handlers=t.handlers||{},this.urls=t.urls||{},this.is_thinking=!1,this.is_updating=!1,this.updating_timer=null,this.items_ids=(t.items_ids||[]).map(this.numToString),this.last_date=t.last_date||0,this.orphan_items={},this.socket=null,this.last_socket_id=null,this.missed_buffer=new u.a({delay:100,onFlush:this.updateMissed.bind(this)}),this.subsite_model=Air.import("module.subsite_model")}numToString(t){return t+""}async handle(t,e){if(void 0!==this.handlers[t])return this.handlers[t].apply(this,e)}destroy(){clearTimeout(this.updating_timer),this.listenSocket(!1),this.missed_buffer.destroy(),this.items_ids=null,this.handlers=null,this.urls=null,this.orphan_items=null}dataToItem(t){return t.id=t.id+"",t}process(t){t.length>0?t.sort((function(t,e){return t.id-e.id})).filter(this.processOne.bind(this)):this.handle("onEmptyButReady")}processOne(t){t=this.dataToItem(t),this.subsite_model.isIgnored(t.user_id)?f.log("comm",`Ignore item ID=${t.id} because of ignored user ID=${t.user_id}`):this.isParentExists(t.reply_to)?this.isExists(t.id)?this.modifyOne(t):this.addOne(t):this.storeOrphan(t)}isExists(t){return this.items_ids.indexOf(t+"")>=0}isParentExists(t){return!(t>0)||this.isExists(t)}addOne(t){this.items_ids.push(t.id+""),this.handle("onAdd",[t]),this.adoptOrphans(t.id).forEach(this.addOne.bind(this))}modifyOne(t){this.handle("onModify",[t])}storeOrphan(t){f.log("comm",`Add orphan ID=${t.id} (parent ID=${t.reply_to})`),this.orphan_items[t.id]=t}adoptOrphans(t){var e,i=[];for(e in this.orphan_items)null!==this.orphan_items[e]&&this.orphan_items[e].reply_to===t&&(f.log("comm",`Parent ID=${t} adopts orphan ID=${e}`),i.push(this.orphan_items[e]),this.orphan_items[e]=null);return i}request(t,e){var i=this;b.b({url:i.urls.diff,data:{last_date:i.last_date},success:function(s){var n,o=s.length;for(n=0;n<o;n++)i.last_date=Math.max(i.last_date,s[n].date_created||0,s[n].date_updated||0);e=e?e.concat(s):s,o>=i.diff_limit?i.request(t,e):t(e)},error:function(e){t(!1,e)}})}sendItem(t,e){var i=this;if(i.isThinking())return;this.setThinkingState(!0);const s={rid:y({is_just_answered:!0,inversion:t.inversion}),text:t.text,media:JSON.stringify(t.media),donate:t.donate,reply_to:t.reply_to,creator_id:t.creator_id};b.c({url:this.urls.add,data:s,success:async function(t){if(!!t.donate){console.log("[Donate] 1. Response received from server");try{t=await i.handle("onBeforeAdd",[t]),console.log("[Donate] 3. Payment success. Place comment")}catch(t){return console.log("[Donate] 3. Payment canceled. Do not proceed",t),i.setThinkingState(!1),void e(!1,t)}}i.setThinkingState(!1),t&&(i.useCloakroom(t.rid,t),i.processOne(t)),i.handle("onSend"),e(!0,t)},error:function(t){i.setThinkingState(!1),e(!1,t)}})}editItem(t,e){var i=this;i.isThinking()||(this.setThinkingState(!0),b.c({url:this.urls.edit,data:{text:t.text,media:t.media,comment_id:t.edited_id},success:function(t){i.processOne(t),i.handle("onSend"),e(!0)},error:function(t){e(!1,t)},complete:function(){i.setThinkingState(!1)}}))}setThinkingState(t){this.is_thinking=!1!==t,this.handle("onThinking",[this.is_thinking])}isThinking(){return this.is_thinking}setUpdatingState(t){this.is_updating=!1!==t,this.handle("onUpdating",[this.is_updating])}update(){var t=this;clearTimeout(this.updating_timer),!1===this.is_updating?(this.setUpdatingState(!0),this.request((function(e){t.setUpdatingState(!1),e&&t.process(e)}))):this.updating_timer=setTimeout(this.update.bind(this),1e3)}loadMore(t,e){var i=this;f.log("comm","Loading more...",t),b.b({url:this.urls.load_more,data:{ids:t.ids.join("_"),with_subtree:t.with_subtree},success:function(t){f.log("comm","More loaded",t),e(t),i.process(t.items)},error:function(t){e(null,t)}})}updateMissed(t){var e=this;t.length<=3?t.forEach((function(t){b.b({url:"/live/missed/socket",data:{id:t,chan:"comments-"+e.id},success:function(t){e.processOne(t.data)},error:function(){}})})):(this.last_date=0,this.update())}listenSocket(t){!1!==t?null===this.socket&&(this.socket=new p.a({name:"comments-"+this.id,onMessage:this.processSocketMessage.bind(this)}),this.socket.open()):null!==this.socket&&(this.socket.close(),this.socket=null)}processSocketMessage(t){var e;if(f.log("comm",`Last socket #${this.last_socket_id}, receive socket #${t._id}`),null===this.last_socket_id&&(this.last_socket_id=t._id),t._id<this.last_socket_id)f.log("comm","...from past (WEIRD!)");else if(t._id-this.last_socket_id>1)for(f.log("comm","...missed"),e=this.last_socket_id+1;e<t._id;e++)this.missed_buffer.add(e);this.last_socket_id<t._id&&(this.last_socket_id=t._id),this.cloakroomHas(t.rid)||(this.useCloakroom(t.rid,t.data),this.processOne(t.data))}cloakroomHas(t){return void 0!==v[t]}useCloakroom(t,e){!function(t,e){const i=v[t];void 0!==i&&e(i)}(t,(function(t){Object(g.a)(e,t)}))}getOriginalItem(t,e){var i=this;this.setThinkingState(!0),b.b({url:this.urls.get4edit,data:{id:t},success:function(t){e(t)},error:function(t){e(!1,t)},complete:function(){i.setThinkingState(!1)}})}getIgnoredItem(t,e){var i=this;this.setThinkingState(!0),b.b({url:this.urls.get_ignored,data:{id:t},success:function(t){e(t)},error:function(t){e(!1,t)},complete:function(){i.setThinkingState(!1)}})}}var k=i(23),w=i(70),T=i(151);class I{constructor(t){this.params=t||{},this.tree=this.createNode(null),this.length=0}createNode(t){return{uid:null===t?this.params.root_uid:t[this.params.self_uid_field],parent_uid:null===t?null:t[this.params.parent_uid_field],level:0,data:t,children:[],children_length:0}}add(t){var e=this,i=this.createNode(t);this.walkNodes((function(t){if(t.uid==i.parent_uid)return t.children[t.children_length++]=i,i.level=t.level+1,e.length++,null}))}sort(t){function e(e,i){return t(e.data,i.data,e.level)}this.walkNodes((function(t){t.children.sort(e)}))}walkNodes(t,e,i,s,n){var o;if(void 0===e&&(e=this.tree),void 0===i&&(i=0),void 0===s&&(s=0),void 0===n&&(n=null),null===t(e,i,s,n))return null;for(o=0;o<e.children_length;o++)if(null===this.walkNodes(t,e.children[o],i+1,o,e))return null}walk(t){return this.walkNodes((function(e,i,s,n){if(null!==e.data)return t(e.data,i,s,n.data)}))}getNodeByUid(t){let e=null;return this.walkNodes((function(i){if(null!==i&&i.uid==t)return e=i,null})),e}getDataByUid(t){const e=this.getNodeByUid(t);return null===e?null:e.data}getLength(t){if(void 0===t)return this.length;{let e=0;return this.walk((function(i){!1!==t(i)&&e++})),e}}getParentUids(t){let e=[];const i=this.getNodeByUid(t);return i&&i.parent_uid&&0!=i.parent_uid&&(e.push(i.parent_uid),e=e.concat(this.getParentUids(i.parent_uid))),e}destroy(){}}var S=i(18);let x=null,D=null,O=1e5,A=!1;function $(t){x=t,D=F(t)}function M(t,e){return t+.5*e}function F(t){const e=n.rect(t);return M(e.top,e.height)}var U=i(46),E=i(1);class j{constructor(t){this.id=t.id,this.handlers=t.handlers,this.auth_data=Air.import("module.auth_data"),this.module_favorite=Air.import("module.favorite"),this.module_votes=Air.import("module.votes"),this.module_date=Air.import("module.date"),this.module_andropov=Air.import("module.andropov"),this.module_comments_admin=Air.import("module.comments_admin"),this.floatingScreen=Air.import("module.floatingScreen"),this.tree_instance=new I({root_uid:"0",self_uid_field:"id",parent_uid_field:"reply_to"}),this.sorting_rules=this.createSortingRules(t.sorting_rules),this.current_sorting_rule=t.current_sorting_rule,this.current_scroll_anchor_id=null,this.render_timer=new k.a(this.render.bind(this)),this.is_ready=!1,this.elements={main:t.element,content:n.bem.find(t.element,"content"),title:n.bem.find(t.element,"title"),title_long:n.bem.find(t.element,"title__long"),title_short:n.bem.find(t.element,"title__short"),sort_items:n.findAll(t.element,".comments__sort .ui-tab"),links_to_all:n.bem.findAll(t.element,"link_to_all a")},this.parseTree(this.elements.content,this.tree_instance),this.current_length=parseInt(n.data(this.elements.title,"count")),this.elements.links_to_all.forEach(t=>{const e=n.attr(t,"href"),{from_comment:i}=Object(U.a)(e.slice(1));if(i){const s=this.tree_instance.getParentUids(i);s.unshift(i);const o=e.replace(/from_comment=(\d+)/g,"from_comment="+s.join(","));n.attr(t,"href",o)}}),this.ready()}createSortingRules(t){var e,i={};for(e in t)i[e]=this.createSortingRule(t[e]);return i}createSortingRule(t){return function(e,i,s){if(e.is_just_answered||i.is_just_answered){const t=e.inversion||1;return t!==(i.inversion||1)?-1===t?-1:1:(e.id-i.id)*t}return t(e,i,s)||e.id-i.id}}setScrollAnchorId(t){this.current_scroll_anchor_id=t||null}rememberScroll(){x=null,D=null,O=1e5,A=!1,null===this.current_scroll_anchor_id?this.tree_instance.walk((function(t){void 0!==t.dom&&function(t){const e=M(0,Object(S.e)()),i=F(t),s=Math.abs(i-e);O>s&&(O=s,$(t))}(t.dom.self)})):($(this.tree_instance.getDataByUid(this.current_scroll_anchor_id).dom.self),this.setScrollAnchorId(null))}restoreScroll(){!1===A&&null!==x&&window.scrollBy(0,F(x)-D),A=!1}ignoreScrollRestoreOnce(){A=!0}refreshRelatedModules(){this.module_favorite.refresh(),this.module_votes.refresh(),this.module_date.refresh(),this.module_andropov.refresh(),this.module_comments_admin.refresh(),this.floatingScreen.refresh()}ready(){!1===this.is_ready&&(this.is_ready=!0,n.bem.add(this.elements.main,"ready"),this.handlers.onReady&&setTimeout(this.handlers.onReady.bind(this),0))}assimilateItem(t,e){return!0!==t.is_assimilated&&(void 0===e&&(e=n.parseHTML(t.html)),void 0===t.dom&&(t.dom={item:e,text:n.bem.find(e,"text"),self:n.bem.find(e,"self"),space:n.bem.find(e,"space"),children:n.bem.find(e,"children"),other:n.bem.find(e,"other"),expand:null}),t.is_mine=this.auth_data.isMe(t.user_id),t.is_removed=n.bem.hasMod(t.dom.self,"removed"),t.is_hidden=n.bem.hasMod(t.dom.item,"hidden"),this.handlers.onItemAssimilated&&this.handlers.onItemAssimilated(t),t.highlight_counter=0,t.is_assimilated=!0),e=null,t}uncollapseAllHigher(t){this.tree_instance.getParentUids(t).forEach(t=>{this.toggleItemMod(t,"collapsed",!1)})}collapseItemById(t,e){var i,s=this.tree_instance.getDataByUid(t);!0===e&&(i=Object(E.c)("Expand the branch"),null===s.dom.expand&&(s.dom.expand=n.parseHTML(`<div class="comments__item__expand" air-click="collapse_subtree?id=${s.id}&state=0">${Object(E.c)("Expand")}</div>`),n.append(s.dom.other,s.dom.expand)),n.html(s.dom.expand,i)),Object(T.a)(s.dom.self)||this.scrollIntoView(t,{to_bottom:!0}),this.toggleItemMod(t,"collapsed",e)}checkItemHighlight(t){var e=this.tree_instance.getDataByUid(t);null!==e&&void 0!==e.dom&&n.bem.toggle(e.dom.space,"highlighted",e.highlight_counter>0)}highlightItem(t,e,i){var s=this.tree_instance.getDataByUid(t);null!==s&&void 0!==s.dom&&(s.highlight_counter+=e?1:-1,s.highlight_counter<0&&(s.highlight_counter=0),this.checkItemHighlight(t),void 0!==i&&setTimeout(this.highlightItem.bind(this),i,t,!e))}parseTree(t,e){var i=this;n.walk(t,(function(t){e.add(i.assimilateItem({id:n.data(t,"id"),reply_to:n.data(t,"reply_to"),user_id:n.data(t,"user_id"),date_created:parseInt(n.data(t,"date")),result_rating:parseFloat(n.data(t,"rating")),donate:parseInt(n.data(t,"donate"))},t))}),".comments__item")}getLastDate(){var t=0;return this.tree_instance.walk((function(e){t<e.date_created&&(t=e.date_created)})),t}getItemsIds(){var t=[];return this.tree_instance.walk((function(e){t.push(e.id)})),t}calculateHeightOfFirstNItems(t){const e=[];this.tree_instance.walk(i=>{if(e.length>=t)return null;e.push(i.dom.space)});return e.reduce((t,e)=>t+n.height(e),0)}addItem(t){this.tree_instance.add(t),this.render_timer.debounce(100)}modifyItem(t){var e=this.tree_instance.getDataByUid(t.id);if(null!==e&&void 0!==e.dom){const i=n.parseHTML(t.html),s=n.bem.find(i,"self");n.replace(e.dom.self,s),e.dom.self=s,e.dom.text=n.bem.find(i,"text"),e.dom.space=n.bem.find(i,"space"),this.render_timer.debounce(100),setTimeout(()=>{this.handlers.onItemModified&&this.handlers.onItemModified(e)},150)}}calculateItemDomIndexes(t){t.dom_index=n.index(t.dom.item)}insertTreeItemIntoDom(t,e,i,s){var o,r;t.dom_index!==i&&(o=null===s?this.elements.content:s.dom.children,0===i?n.prepend(o,t.dom.item):void 0===(r=n.children(o,".comments__item")[i-1])?n.append(o,t.dom.item):n.after(r,t.dom.item))}sort(t){this.elements.sort_items.forEach((function(e){n.bem.toggle(e,"active",n.data(e,"sort")===t)})),this.current_sorting_rule=t,this.render_timer.reset(),this.render({ignore_scroll_restorance:!0})}render(t){var e=this;void 0===t&&(t={}),!0!==t.ignore_scroll_restorance&&this.is_ready&&this.rememberScroll(),this.tree_instance.sort(this.sorting_rules[this.current_sorting_rule]),this.tree_instance.walk((function(t){e.assimilateItem(t,t.dom&&t.dom.item)})),this.tree_instance.walk(this.calculateItemDomIndexes.bind(this)),this.tree_instance.walk(this.insertTreeItemIntoDom.bind(this)),this.updateTitle(),this.refreshRelatedModules(),!0!==t.ignore_scroll_restorance&&this.restoreScroll()}toggleItemMod(t,e,i){n.bem.toggle(this.tree_instance.getDataByUid(t).dom.item,e,i)}toggleItemSpaceMod(t,e,i){n.bem.toggle(this.tree_instance.getDataByUid(t).dom.space,e,i)}getElementForForm(t){return this.tree_instance.getDataByUid(t).dom.children}isItemHere(t){const e=this.tree_instance.getDataByUid(t);return null!==e&&void 0!==e.dom}scrollIntoView(t,e,i){var s,o=this.elements.main,a=e||{},d=a.with_animation?"easeInOutCubic":null,l=0,h=a.duration;l=r.g?-20:-80,void 0!==t&&null!==(s=this.tree_instance.getDataByUid(t))&&void 0!==s.dom&&(o=s.dom.item,l=r.g?-48:-200,!0===a.to_bottom&&(l+=n.rect(s.dom.self).height)),w.a(o,{shift:l,easing:d,duration:h},i)}scrollAndHighlight(t,e,i){!0===e.with_animation&&(e.duration=400),this.scrollIntoView(t,e,i),this.highlightItem(t,!0,2500)}setTitle(t){this.current_length<t&&(n.html(this.elements.title_long,t+" "+Object(E.a)("comment","comments",t)),this.current_length=t)}updateTitle(){this.setTitle(this.getLength())}getLength(){const t=this.tree_instance.getLength((function(t){return!0!==t.is_removed&&!0!==t.is_hidden}));return Math.max(this.current_length,t)}destroy(){this.handlers.onDestroy&&this.handlers.onDestroy(),this.tree_instance.destroy(),this.render_timer.destroy(),this.elements=n.nullDom(this.elements)}}var B=i(6),P=i(15),H=i(581),R=i(22);class N extends H.a{constructor(t,{id:e,subsite_id:i,events:s,is_enabled_donates:o}){super(s),this.id=e,this.subsite_id=i,this.storage_name_unsent="comments_unsent_"+e,this.delimeterSymbol=null,this.is_enabled_donates=o,this.$dom={main:t,last_after:n.next(t),editor:n.bem.find(t,"editor")},this.current_replying_id=0,this.current_mode="new",this.current_inversion=1,this.current_creator_id=null,this.module_auth_data=Air.import("module.auth_data"),this.initThesis().then(()=>this.initDonateAttacher()).then(()=>{this.module_auth_data.on("Change",this.setUserData.bind(this)),this.checkUnsent()})}async initThesis(){if(this.$dom.editor){const{default:t}=await i.e(38).then(i.bind(null,1566));this.thesis=new t(this.$dom.editor,{submitTitle:Object(E.c)("Send"),placeholder:Object(E.c)("Write a comment..."),blocksOptions:{text:{exporter:({type:t,data:e},i)=>{switch(t){case"command":switch(e.command_name){case"user":return`[@${e.id}|${e.value}]`;default:return i}case"break":return"\n";default:return i}},preImporter:t=>t.replace(/\[@(\d+)\|([^\]]+)\]/gi,'<thesis-command data-id="$1" data-value="$2" data-command_name="user">@$2</thesis-command>'),importer:t=>{switch(t.tagName.toLowerCase()){case"thesis-command":return{type:"command",data:t.dataset};default:return null}}}},events:{possessionChanged:t=>{this.setUserData(t)},submit:({blocksData:t,attachedData:e})=>{const i=function(t){const e=t.trim().length,i={};return e<=0?(i.error_msg=Object(E.c)("You need to write something"),i.error_code=1):e>5e3?(i.error_msg=Object(E.c)("Comment is too long, keep it in %{ max } characters limit, please",{max:5e3}),i.error_code=2):(i.error_msg=null,i.error_code=null),i.text=t,i}(t.reduce((t,{type:e,content:i})=>(e===this.thesis.BLOCKS_TYPES.TEXT&&i&&t.push(i),t),[]).join(this.delimeterSymbol)),s=this.donateAttacher?this.donateAttacher.value:0;if(1===i.error_code&&(e.length>0||s>0)&&(i.error_msg=null,i.error_code=null),i.media=e,i.donate=s,null===i.error_msg)switch(this.current_mode){case"new":case"reply":this.callEvent("onWantAdd",{text:i.text,media:i.media,donate:i.donate,id:this.current_replying_id,inversion:this.current_inversion,creator_id:this.current_creator_id});break;case"edit":this.callEvent("onWantEdit",{text:i.text,media:i.media,id:this.current_replying_id});break;default:this.callEvent("onSubmitError",{message:`Invalid current mode "${this.current_mode}"`})}else this.callEvent("onSubmitError",{message:i.error_msg})},cancel:()=>{this.place(null)},textChanged:t=>{t?this.storeUnsent({text:t,parent_id:this.current_replying_id}):this.storeUnsent(null),this.setFilledState()},undo:()=>{this.setFilledState()},redo:()=>{this.setFilledState()},focus:({state:t})=>{n.bem.toggle(this.$dom.main,"focused",t)},attachChanged:()=>{this.setFilledState()}}}),this.scroller=new R.a((t,e)=>{t===this.$dom.editor&&this.callEvent("onVisibilityChange",{isVisible:e})}),this.scroller.addElement(this.$dom.editor)}}async initDonateAttacher(){if(!this.is_enabled_donates||!this.$dom.editor||!this.thesis)return;const{default:t}=await Promise.all([i.e(0),i.e(1),i.e(2),i.e(8),i.e(30)]).then(i.bind(null,1568));this.donateAttacher=new t({parent:this.thesis.$dom.attaches,attachmentParent:this.thesis.$dom.uploaded,onChange:()=>this.setFilledState()})}destroy(){this.module_auth_data.off(),this.thesis&&this.thesis.destroy(),this.scroller&&this.$dom.editor&&(this.scroller.removeElement(this.$dom.editor),this.scroller.destroy()),this.$dom=n.nullDom(this.$dom)}setFilledState(){if(this.thesis)if(this.donateAttacher&&this.donateAttacher.value){const t=!0;n.bem.toggle(this.$dom.main,"filled",t),this.thesis.setSubmitState(!t)}else Promise.all([this.thesis.getText(this.delimeterSymbol),this.thesis.getAttachedData()]).then(([t,e])=>{const i=!(!t&&!e.length);n.bem.toggle(this.$dom.main,"filled",i),this.thesis.setSubmitState(!i)})}setDisabledState(t){this.thesis&&this.thesis.disable(t)}setWaitingState(t){this.thesis&&this.thesis.wait(t)}storeUnsent(t=null){t?P.d(this.storage_name_unsent,t,!0):P.c(this.storage_name_unsent)}checkUnsent(){const t=this.getUnsent();t&&t.parent_id===this.current_replying_id?this.setText(t.text):this.setText(""),this.setFilledState()}getUnsent(){return P.b(this.storage_name_unsent,!0)}handleTextChanges(t=!0){}setText(t){this.thesis&&this.thesis.setText(t,this.delimeterSymbol)}setMedia(t){this.thesis&&this.thesis.setMedia(t)}setPlaceholder(t){this.thesis&&this.thesis.setPlaceholder(t)}setFocus(t){this.thesis&&this.thesis.setFocus(t)}place(t){let e=null;switch(null===t&&(t={mode:"new",short_level:"0"}),this.callEvent("beforePlaced",t),this.clear(),t.mode){case"new":e=void 0===t.before?this.$dom.last_after:t.before,n.before(e,this.$dom.main),this.current_inversion=parseInt(n.data(e,"inversion")),void 0!==t.before&&(this.$dom.last_after=t.before),n.bem.toggle(this.$dom.main,"replying",!1),n.bem.toggle(this.$dom.main,"editing",!1),this.setPlaceholder(Object(E.c)("Write a comment...")),this.setButtonTitle({text:Object(E.c)("Send"),icon:"v_long_up",isShort:"1"===t.short_level}),this.thesis&&this.thesis.removeCustomButtons(),this.donateAttacher&&this.donateAttacher.setDisabled(!1),this.current_mode="new",this.current_replying_id=0;break;case"reply":n.before(t.before,this.$dom.main),n.bem.toggle(this.$dom.main,"replying",!0),n.bem.toggle(this.$dom.main,"editing",!1),this.setPlaceholder(Object(E.c)("Write a reply...")),this.setButtonTitle({text:Object(E.c)("Reply"),icon:"v_long_up",isShort:"1"===t.short_level}),this.thesis&&this.thesis.addCustomButton({name:"cancel",label:Object(E.c)("Cancel")},!0),this.donateAttacher&&this.donateAttacher.setDisabled(!0),this.current_mode="reply",this.current_replying_id=t.id,this.current_inversion=-1;break;case"edit":n.before(t.before,this.$dom.main),n.bem.toggle(this.$dom.main,"replying",!1),n.bem.toggle(this.$dom.main,"editing",!0),this.current_mode="edit",this.current_replying_id=t.id,this.current_inversion=1,this.setPlaceholder(Object(E.c)("Edit the comment...")),this.setButtonTitle({text:Object(E.c)("Edit"),icon:"v_tick",isShort:"1"===t.short_level}),this.thesis&&this.thesis.addCustomButton({name:"cancel",label:Object(E.c)("Cancel")},!0),this.donateAttacher&&this.donateAttacher.setDisabled(!0),this.callEvent("requireOriginalData",t.id);break;default:console.warn("comm","Form: Invalid place options",t)}this.checkUnsent(),this.setFocus(!0===t.focus),this.callEvent("afterPlaced",t)}setButtonTitle({text:t,icon:e,isShort:i}){this.thesis&&this.thesis.setSubmitTitle({text:t,icon:e,isShort:i})}clear(){this.thesis&&this.thesis.clear(),this.donateAttacher&&this.donateAttacher.clear()}setUserData(t){t&&(this.thesis&&this.thesis.setUserData(t),this.current_creator_id=t.id)}}var L=i(12);class W{constructor(t){const e=this;this.settings=JSON.parse(n.html(n.find(t.element,"[air-settings]"))),this.$dom={main:t.element},this.controlling_module=t.controlling_module,this.module_DOM=new B.a,this.module_ajaxify=Air.import("module.ajaxify"),this.comments_last_visit=Air.import("module.comments_last_visit"),this.is_activated=!1,this.current_visit_time=this.comments_last_visit.getCurrentTime(),this.last_visit_time=this.settings.last_count_and_date?this.settings.last_count_and_date.date:this.comments_last_visit.getLocalLastTime(this.settings.id),this.CommentsFolding_instance=new c,this.CommentsUpdates_instance=new _({element:n.find(t.element,".comments_updates"),handlers:{onAdd:function(t){e.CommentsTree_instance.toggleItemSpaceMod(t,"new",!0)},onRemove:function(t,i){i||(e.CommentsUpdates_instance.block(!0),e.CommentsTree_instance.uncollapseAllHigher(t),e.CommentsTree_instance.scrollAndHighlight(t,{with_animation:!0},(function(){e.CommentsUpdates_instance.block(!1)}))),e.CommentsTree_instance.toggleItemSpaceMod(t,"new",!1)}}}),this.CommentsTree_instance=new j({element:t.element,id:this.settings.id,handlers:{onReady:function(){e.processQuery(!1),n.delegateEvent(t.element,".comments__item__space","mouseover",(function(){e.CommentsUpdates_instance.remove(n.data(n.parents(this,".comments__item"),"id"),!0)}))},onItemAssimilated:function(t){if(!1===t.is_mine){const i=null!==e.last_visit_time&&t.date_created>e.last_visit_time,s=null===e.last_visit_time&&t.date_created>e.current_visit_time;(i||s)&&e.CommentsUpdates_instance.delayedAdd(t.id)}e.controlling_module.triggerChain("Comment assimilated",t)},onItemModified:function(t){e.controlling_module.triggerChain("Comment modified",t)},onDestroy:function(){n.off(t.element)}},sorting_rules:{best:function(t,e){return e.donate*!e.is_removed-t.donate*!t.is_removed||e.result_rating-t.result_rating},old:function(){return 0}},current_sorting_rule:s.a("comments_sorting")||"best"}),this.CommentsModel_instance=new C({id:this.settings.id,author_id:this.settings.author_id,diff_limit:this.settings.diff_limit,urls:this.settings.urls,last_date:this.CommentsTree_instance.getLastDate(),items_ids:this.CommentsTree_instance.getItemsIds(),handlers:{onBeforeAdd:t=>e.CommentsForm_instance.donateAttacher.processPayment(t),onAdd:function(t){e.CommentsTree_instance.addItem(t)},onModify:function(t){e.CommentsTree_instance.modifyItem(t)},onThinking:function(t){e.CommentsForm_instance&&(e.CommentsForm_instance.setWaitingState(t),e.CommentsForm_instance.setDisabledState(t))}}}),this.CommentsForm_instance=new N(n.find(t.element,".comments_form"),{id:this.settings.id,subsite_id:this.settings.subsite_id,is_enabled_donates:this.settings.is_enabled_donates,events:{onWantAdd:t=>{this.controlling_module.trigger("Comment added"),this.CommentsModel_instance.sendItem({text:t.text,media:t.media,donate:t.donate,reply_to:t.id,inversion:t.inversion,creator_id:t.creator_id},(e,i)=>{!1!==e&&(this.CommentsForm_instance.clear(),this.CommentsForm_instance.storeUnsent(!1),this.CommentsForm_instance.place(null),t.donate&&setTimeout(()=>{this.CommentsTree_instance.scrollIntoView(i.id)},100),"dtf"===window.__codename&&Math.random()>=.66&&t.text.indexOf("╭∩╮")>=0&&o.success("(° ͜ʖ͡°)╭∩╮"),Math.random()>=.99&&o.success(Math.random()<.5?Object(E.c)("Great comment, keep it up!"):Object(E.c)("Nothing is better than a good comment")))}),Object(L.sendDefaultEvent)("Comments — Submit — Click"),t.donate&&Object(L.sendDefaultEvent)("Comments — Submit with donation — Click")},onWantEdit:t=>{this.controlling_module.trigger("Comment edited"),this.CommentsModel_instance.editItem({text:t.text,media:t.media,edited_id:t.id},t=>{!1!==t&&(this.CommentsForm_instance.clear(),this.CommentsForm_instance.storeUnsent(!1),this.CommentsForm_instance.place(null))})},requireOriginalData:t=>{this.CommentsForm_instance.setDisabledState(!0),this.CommentsModel_instance.getOriginalItem(t,t=>{this.CommentsForm_instance.setDisabledState(!1),t&&(this.CommentsForm_instance.setText(t.pure_text),this.CommentsForm_instance.setMedia(t.media),this.CommentsForm_instance.setFocus(!0))})},onSubmitError:t=>{o.error(t.message)},beforePlaced:t=>{this.CommentsTree_instance.setScrollAnchorId(t.id||null),this.CommentsTree_instance.rememberScroll()},afterPlaced:t=>{this.CommentsTree_instance.restoreScroll(),!r.g||"reply"!==t.mode&&"edit"!==t.mode||this.CommentsTree_instance.scrollAndHighlight(t.id,{to_bottom:!0})},onVisibilityChange:({isVisible:t})=>{const e=this.is_activated,i=this.CommentsUpdates_instance.is_active;r.g&&e&&(t&&i&&this.CommentsUpdates_instance.activate(!1),t||i||this.CommentsUpdates_instance.activate(!0))}}}),this.module_DOM.on("place_form",(function(t){var i=null;switch(t.data.to){case"before_me":i={mode:"new",before:t.el,focus:!0,short_level:t.data.short_level};break;case"item":i={mode:t.data.mode,id:t.data.id,before:e.CommentsTree_instance.getElementForForm(t.data.id),focus:!0,short_level:t.data.short_level}}e.CommentsForm_instance.place(i)})),this.module_DOM.on("comments_highlight_id",(function(t){e.CommentsTree_instance.highlightItem(n.data(t.el,"id"),!0)})),this.module_DOM.on("comments_unhighlight_id",(function(t){e.CommentsTree_instance.highlightItem(n.data(t.el,"id"),!1)})),this.module_DOM.on("comments_sort",(function(t){const i=n.data(t.el,"sort");e.CommentsTree_instance.sort(i),s.c("comments_sorting",i,365)})),this.module_DOM.on("load_more",(function(t){var i;e.CommentsFolding_instance.add(t.el),(i=e.CommentsFolding_instance.get(t.el)).setWait(!0),e.CommentsModel_instance.loadMore({ids:i.getIds(),with_subtree:i.isWithSubtree()},(function(t){if(null!==t){i.substract(t.items.map((function(t){return t.id+""}))),i.setCount(t.remaining_count);let s=i.getParentId();0==s&&(s=null),e.CommentsTree_instance.setScrollAnchorId(s)}i.setWait(!1)}))})),this.module_DOM.on("collapse_subtree",(function(t){e.CommentsTree_instance.collapseItemById(t.data.id,"1"===t.data.state)})),this.module_ajaxify.on("Scroll to comments",(function(){e.processQuery(!0)})),this.module_ajaxify.on("Before request",()=>{this.updateVisitData()}),n.on(window,"beforeunload.classComments",()=>{this.updateVisitData()}),this.module_DOM.on("show-ignored",({el:t})=>{const i=n.data(t,"comment-id");this.CommentsModel_instance.getIgnoredItem(i,t=>{t&&e.CommentsTree_instance.modifyItem(t)})}),this.checkRolledUpHeight()}checkRolledUpHeight(){if(this.settings.rolled_up){const t=this.CommentsTree_instance.calculateHeightOfFirstNItems(this.settings.rolled_up_limit),e=n.bem.find(this.$dom.main,"content_wrapper__container");n.height(e,t)}}updateVisitData(){this.comments_last_visit.setCount(this.settings.id,this.CommentsTree_instance.getLength())}unrollRolledUp(){n.bem.add(n.bem.find(this.$dom.main,"content_wrapper "),"open")}processQuery(t){const e=Object(a.e)();if(e.comments)if(e.from_comment){const t=e.from_comment.split(",");let i=null;for(;t.length>0;){const e=t.shift();if(this.CommentsTree_instance.isItemHere(e)){i=e;break}}i?this.CommentsTree_instance.scrollAndHighlight(i,{with_animation:!1}):this.scrollToAll()}else this.scrollToAll();else e.comment&&(this.CommentsTree_instance.isItemHere(e.comment)||e.hard?(this.unrollRolledUp(),this.CommentsTree_instance.scrollAndHighlight(e.comment,{with_animation:t}),void 0!==e.mode&&this.CommentsForm_instance.place({mode:e.mode,id:e.comment,before:this.CommentsTree_instance.getElementForForm(e.comment),focus:!0})):this.module_ajaxify.goTo(`?comment=${e.comment}&hard`))}scrollToAll(){this.CommentsTree_instance.scrollIntoView()}activate(t){!1!==t&&!1===this.is_activated&&(this.is_activated=!0,this.CommentsModel_instance.listenSocket(!0)),this.CommentsUpdates_instance.activate(t)}setFormText(t,e=!1){this.CommentsForm_instance.setText(t),e&&this.CommentsForm_instance.setFocus(!0)}destroy(){this.CommentsTree_instance.destroy(),this.CommentsModel_instance.destroy(),this.CommentsForm_instance.destroy(),this.CommentsUpdates_instance.destroy(),this.CommentsFolding_instance.destroy(),this.module_DOM.off(),this.module_ajaxify.off(),n.off(window,"beforeunload.classComments")}}},581:function(t,e,i){"use strict";i.d(e,"a",(function(){return s}));class s{constructor(t={},e={}){this.events=t,this.prepend=e.prepend||[],this.append=e.append||[]}callEvent(...t){const e=t.shift();void 0===this.events[e]||this.events[e].apply(this,this.prepend.concat(t).concat(this.append))}proxyMethods(t,e=[]){e.forEach(e=>{this[e]=t[e].bind(t)})}}}}]);