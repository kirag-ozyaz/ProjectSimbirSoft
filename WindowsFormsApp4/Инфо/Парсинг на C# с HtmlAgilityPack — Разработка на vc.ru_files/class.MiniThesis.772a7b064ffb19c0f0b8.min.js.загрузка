(window.webpackJsonp=window.webpackJsonp||[]).push([[38],{1566:function(t,e,s){"use strict";s.r(e),s.d(e,"default",(function(){return rt}));var n=s(0),i=s(8),a=s(1),o=s(6),l=s(11),r=s(9),h=s(581),c=s(23),d=s(550);class u{constructor({getter:t=null,setter:e=null}){this.getter=t,this.setter=e,this.past=[],this.future=[],this.lastAppliedHash=null,this.timer=new c.a(this.snap.bind(this))}destroy(){this.timer.destroy()}getCurrent(){return this.past[this.past.length-1]||null}snap(t=0){t>0?this.timer.debounce(t):(this.timer.reset(),this.getter().then(t=>{const e=Object(d.a)(t),s=this.getCurrent();null!==s&&s.hash===e||(this.pushPast({hash:e,data:t}),this.clearFuture())}))}clearFuture(){this.future=[]}pushPast(t){null!==t&&this.past.push(t)}popPast(){return this.past.pop()||null}unshiftFuture(t){null!==t&&this.future.unshift(t)}shiftFuture(){return this.future.shift()||null}back(){return this.unshiftFuture(this.popPast()),this.applyCurrent()}forward(){return this.pushPast(this.shiftFuture()),this.applyCurrent()}applyCurrent(){const t=this.getCurrent();return null!==t&&t.hash!==this.lastAppliedHash&&(this.timer.reset(),this.lastAppliedHash=t.hash,this.setter(t.data),!0)}}var m=s(2),p=s(587),g=s(73);m.define("aup","AndropovUploaderPanel Ꮚ˘ꈊ˘Ꮚ","#eac124");class v extends h.a{constructor(t,{events:e,limit:s=1,detailedLimit:i={},previewSize:a=80,mainClass:o="andropov_uploader",waitingTime:l=500}){super(e),this.itemsLimit=s,this.detailedLimit=i,this.items=[],this.bannedSignatures=[],this.previewSize=a,this.mainClass=o,this.isWaitingState=!1,this.waitingTime=l,this.parseTextTimer=null,this.$dom={main:t},n.addClass(t,this.mainClass)}destroy(){clearTimeout(this.parseTextTimer),this.$dom=Object(g.a)(this.$dom)}createStructure(){}getLimitForThisType(t){return void 0===this.detailedLimit||void 0===this.detailedLimit[t]?this.itemsLimit:this.detailedLimit[t]}banSignature(t){m.log("aup","banSignature",t),this.bannedSignatures.push(t)}isSignatureBanned(t){return this.bannedSignatures.indexOf(t)>=0}unbanAllSignatures(){m.log("aup","unbanAllSignatures"),this.bannedSignatures=[]}isSignatureExists(t){if(null!==t){if(this.items.some(e=>e.signature===t))return!0}return!1}clear(){this.removeItems(this.items.slice()),this.unbanAllSignatures()}wait(t=!0){m.log("aup","wait",t),this.isWaitingState=t,this.callEvent("wait",t)}isWaiting(){return this.isWaitingState}parseText(t){return!!r.textHasLinks(t)&&(this.wait(!0),r.parseText(t,(t,e)=>{this.wait(!1),this.addItems(t,e)}),!0)}parseTextDebounce(t,e=0){clearTimeout(this.parseTextTimer),this.parseTextTimer=setTimeout(this.parseText.bind(this,t),e)}addFiles(t){this.wait(!0),m.log("aup","addFiles",t),t.forEach(t=>{t._rand=Object(l.a)()}),r.uploadFiles(t,(t,e)=>{this.wait(!1),this.addItems(t,e)})}addItems(t,e=[]){t.forEach((t,s)=>{this.addItem(t,e[s])})}addItem(t,e=null){m.log("aup","addItem",t,e),void 0!==e&&(this.isSignatureExists(e)||this.isSignatureBanned(e))||(this.items.push({uid:Object(l.a)(),signature:e,isProcessed:!1,andropovWrapper:new p.a(t),$previewElement:null,$previewElementRemove:null}),this.checkItemsLimit(),this.processItems())}checkItemsLimit(){m.log("aup","checkItemsLimit");const t=this.items.reduce((t,e)=>{const s=e.andropovWrapper.getType();return void 0===t[s]&&(t[s]=0),t[s]++,t},{}),e=this.items.reduce((e,s)=>{const n=s.andropovWrapper.getType();return t[n]>this.getLimitForThisType(n)&&(e.push(s),t[n]--),e},[]);e.length>0&&(m.log("aup","Limit quota exceeded"),this.removeItems(e))}removeItems(t){t.forEach(this.removeItem.bind(this))}removeItem(t,e=!1){m.log("aup","removeItem",t,e);for(let s=this.items.length-1;s>=0;s--)if(this.items[s].uid===t.uid){this.removeItemFromPreview(t),this.items.splice(s,1),e&&this.banSignature(t.signature);break}this.callEvent("change",this.get(),this.getData())}removeItemFromPreview(t){t.$previewElement&&(n.off(t.$previewElement),n.off(t.$previewElementRemove),n.remove(t.$previewElement),t.$previewElement=null,t.$previewElementRemove=null)}processItems(){m.log("aup","processItems"),this.items.forEach(t=>{t.isProcessed||(null===t.$previewElement&&this.addItemToPreview(t),t.isProcessed=!0)}),this.callEvent("change",this.get(),this.getData())}addItemToPreview(t){m.log("aup","addItemToPreview",t),t.$previewElement=n.parseHTML(this.getPreviewItemHtml(t)),t.$previewElementRemove=n.bem.find(t.$previewElement,"remove"),n.one(t.$previewElementRemove,"click",this.removeItem.bind(this,t,!0)),n.append(this.$dom.main,t.$previewElement)}getPreviewItemHtml(t){return`<div class="${this.mainClass}__preview_item">\n              <div class="${this.mainClass}__preview_item__inner">\n                ${t.andropovWrapper.getPreviewHtml({size:this.previewSize})}\n                <div class="${this.mainClass}__preview_item__remove"></div>\n              </div>\n            </div>`}getData(){return this.get().then(t=>t.map(t=>t.getData()).filter(t=>null!==t))}get(){return this.isWaiting()?new Promise(t=>{setTimeout(()=>{t(this.get())},this.waitingTime)}):Promise.resolve(this.items.map(t=>t.andropovWrapper))}}var f=s(24),b=s(71);class _ extends f.b{constructor(t){super(),this.params=t,this.dom={triangle:null,dropdownPlace:null,container:this.params.container,avatar:this.params.avatar},this.createStructure()}createStructure(){this.dom.triangle=n.parseHTML('<div class="possession_triangle"></div>'),this.dom.dropdownPlace=n.parseHTML('<div class="possession_dropdown_place"></div>'),n.css(this.dom.container,"position","relative"),n.append(this.dom.container,this.dom.triangle),n.append(this.dom.container,this.dom.dropdownPlace),n.addClass(this.dom.container,"possession_inited"),n.on(this.dom.triangle,"click",this.constructor.triangleClickHandler.bind(this)),this.dropdown=new b.a({container:this.dom.dropdownPlace,options:{bubble:{arrowAlignment:"top right",title:Object(a.c)("Profile")},search:{ajax:{url:this.params.url},showIfMoreItemsAvailable:!0},list:{type:"image+text",items:[],selectable:!0,maxVisibleItems:6},permanentList:{type:"image+text",align:"bottom",items:[]}}}),this.dropdown.on("select",t=>{this.trigger("change",t)})}updatePossessionList(){this.dropdown.setItems()}static triangleClickHandler(){this.dropdown.toggle()}destroy(){n.nullDom(this.dom),this.params=null,this.dropdown&&this.dropdown.destroy()}}class S extends h.a{constructor(t=null,e={}){const s=Object(l.a)();super(e.events,{prepend:[s]}),this.uid=s,this.type=t,this.$dom={main:n.parseHTML(`<div class="thesis__block thesis__block--${t}" data-id="${s}"></div>`)},this.is_inited=!1,this.is_selected=!1}init(){return!this.is_inited&&(this.is_inited=!0,!0)}getContent(){return console.warn(`class.ThesisBlock -> "getContent" for type "${this.type}" is not set`),Promise.resolve(null)}setContent(){console.warn(`class.ThesisBlock -> "setContent" for type "${this.type}" is not set`)}getData(){return this.getContent().then(t=>({type:this.getType(),content:this.clearEmptyness(t)}))}getUid(){return this.uid}isUid(t){return this.getUid()==t}getType(){return this.type}isType(t){return this.getType()===t}getElement(){return this.$dom.main}remove(){n.remove(this.getElement())}appendTo(t){n.append(t,this.getElement())}insertAfter(t){n.after(t,this.getElement())}insertBefore(t){n.before(t,this.getElement())}select(t=!0){this.is_selected=t,n.bem.toggle(this.$dom.main,"selected",t)}isSelected(){return this.is_selected}focus(t=!0){}clearEmptyness(t){return Object(i.collapseIfSpacesOnly)(t)}}var k=s(35),T=s(17);function $(t){return"ce-"+t}function E(t){const e=new RegExp("ce-(.+)","i").exec(t);switch(t){case"BR":return"break";default:return null===e?null:(e[1]||"").toLowerCase()}}function w(t,e,s=NodeFilter.SHOW_ALL){const n=t.ownerDocument.createTreeWalker(t,s,null,!1);let i;for(;null!==(i=n.nextNode())&&null!==e(i););i=null}function C(t,e=[]){return function(t,e=[]){const s=e.join("|");return""===s?t:t.replace(new RegExp("<\\/?("+s+")[^>]*>","gi"),"")}(t,e.map(t=>$(t)))}function x(t,e){return null===t?null:(s=y(t),i=$(e),!0===n.matches(s,i)?s:void 0===(s=n.parents(s,i))?null:s);var s,i}function y(t){return function(t){return t.nodeType===Node.TEXT_NODE}(t)?t.parentElement:t}function I(t,e){const s=x(t,e);return null!==s?n.unwrap(s):null}function B(t,e){return null!==x(t,e)}function A(t){const e=t.commonAncestorContainer.parentNode.cloneNode(!1);return e.appendChild(t.cloneContents()),e.innerHTML}function D(t){const e=n.textNode(" ");return n.after(t,e),e}function L(t){return t.rangeCount>0?t.getRangeAt(0):null}function H(t,e){if(e.appendChild(t.extractContents()),t.startContainer===document){const e=n.find("[contenteditable]");t.setStart(e,0)}t.insertNode(e)}function P(t,e){const s=L(t);null!==s&&H(s,e)}function N(t,e){return Object(T.a)(t).reduce((t,s)=>(t.push({it:e(s),children:N(s.childNodes,e)}),t),[])}function R(t,e){return t.reduce((t,{it:s,children:n})=>t+e(s,R(n,e)),"")}function O(t){return t.replace(/(?:\r\n|\r|\n)/g,"<br>")}class M extends h.a{constructor(t,{events:e,html:s=""}){super(e),this.$dom={parent:t,main:null},this.data={uid:Object(l.a)()},this.saved_selection=null,this.createStructure(s),document.execCommand("DefaultParagraphSeparator",!1,"br"),document.queryCommandSupported("insertBrOnReturn")}destroy(){n.off(this.$dom.main),n.off(this.getDocument(),"."+this.getNamespace()),n.remove(this.$dom.main)}getDocument(){return document}getWindow(){return this.getDocument().defaultView}lock(t=!0){this.$dom.main.contentEditable=!t}getNamespace(){return"content_editable_"+this.data.uid}createStructure(t){this.$dom.main=n.parseHTML('<p class="content_editable" contenteditable="true"></p>'),n.on(this.$dom.main,"keydown",this.handleKeyDown.bind(this)),n.on(this.$dom.main,"keyup",this.handleKeyUp.bind(this)),n.on(this.$dom.main,"paste",this.handlePaste.bind(this)),n.on(this.$dom.main,"drop",this.handleDrop.bind(this)),n.on(this.$dom.main,"input",this.handleInput.bind(this)),n.on(this.$dom.main,"focus",this.handleFocus.bind(this)),n.on(this.$dom.main,"blur",this.handleBlur.bind(this)),n.on(this.getDocument(),"selectionchange."+this.getNamespace(),this.handleSelectionChange.bind(this)),n.on(this.getDocument(),"mousedown."+this.getNamespace(),this.handleMouseDown.bind(this)),n.on(this.getDocument(),"mouseup."+this.getNamespace(),this.handleMouseUp.bind(this)),n.append(this.$dom.parent,this.$dom.main),this.setHtml(t)}getText(){return n.text(this.$dom.main)}getHtml(){return n.html(this.$dom.main)}setHtml(t){n.html(this.$dom.main,t),this.normalizeTextNodes(),this.collapseEmptyTags()}appendHtml(t){n.appendHTML(this.$dom.main,t)}clear(){this.setHtml("")}getSelection(){return this.getWindow().getSelection()}isSelectionCollapsed(){return this.getSelection().isCollapsed}getRange(){return L(this.getSelection())}collapse(t=!1){const e=this.getRange();null!==e&&e.collapse(t)}wrapSelectionInNode(t){return P(this.getSelection(),t)}wrapSelectionInHtml(t){return function(t,e){const s=n.parseHTML(e);return P(t,s),s}(this.getSelection(),t)}exportJson(){return N(this.$dom.main.childNodes,t=>({type:t.nodeType===Node.TEXT_NODE?null:E(t.tagName),text:t.nodeType===Node.TEXT_NODE?t.textContent:null,data:t.dataset||null}))}exportHtml(t){return R(this.exportJson(),t)}importHtml(t,e){const s=N(n.parseHTML(t,!0,!0),e);this.setHtml(R(s,({type:t=null,text:e=null,data:s=null},i="")=>{if(null===t)return null===e?i:O(e);{const e=$(t);return`<${e} ${n.dataToAttrs(s)}>${i}</${e}>`}}))}makeTag(t,e,s){const i=function(t,e=null,s=""){const n=$(t),i=[];if(null!==e)for(const t in e)i.push(`data-${t}="${e[t]}"`);return`<${n} ${i.join(" ")}>${s}</${n}>`}(t,e,s),a=this.wrapSelectionInHtml(i);return function(t,e){const s=[];let i=0;n.walk(t,e=>{n.eachParent(e,t=>{if(n.isSameTags(e,t))return s[i++]=e,null},t)},$(e),!0);for(let t=0;t<i;t++)n.unwrap(s[t])}(this.$dom.main,t),this.normalizeTextNodes(),a}collapseEmptyTags(t){var e;e=this.$dom.main,n.walk(e,t=>{if(t===e)return null;""===t.innerHTML&&"BR"!==t.tagName&&n.unwrap(t)},void 0,!0)}normalizeTextNodes(t=this.$dom.main){t.normalize()}handleKeyDown(t){return this.callEvent("keydown",t)}handleKeyUp(t){return this.callEvent("keyup",t)}handlePaste(t){return this.callEvent("paste",t)}handleDrop(t){return this.callEvent("drop",t)}handleInput(t){return this.callEvent("input",t)}handleFocus(t){return this.callEvent("focus",t,!0)}handleBlur(t){return this.callEvent("focus",t,!1)}pasteRawHtmlAtSelection(t){this.getDocument().execCommand("insertHTML",!1,t)}pasteHtmlAtSelection(t,e=[]){const s=this.whichOfTheseTypesSelectionBelongsTo(e);t=O(t=C(t=t.replace(/<\/?[^>]+(>|$)/g,""),s)),this.pasteRawHtmlAtSelection(t),this.normalizeTextNodes()}joinHtml(t,e){this.setHtml(this.getHtml()+t)}breakSelectionTag(t){const e=this.getSelectionStartNode(),s=this.getSelectionEndNode();let n=[];if(null!==e){const s=I(e,t);null!==s&&(n=n.concat(s))}if(null!==s){const e=I(s,t);null!==e&&(n=n.concat(e))}return n}isSelectionBelongsToType(t){const e=this.getRange();return null!==e&&B(e.commonAncestorContainer,t)}isSelectionStartsInType(t){const e=this.getSelectionStartNode();return null!==e&&B(e,t)}isSelectionEndsInType(t){const e=this.getSelectionEndNode();return null!==e&&B(e,t)}isSelectionCrossesType(t){return this.isSelectionStartsInType(t)||this.isSelectionEndsInType(t)}isSelectionContainsType(t){const e=this.getSelectionCommonElement(),s=this.getSelectionStartElement(),n=this.getSelectionEndElement();let i=!1,a=!1;return B(s,t)||B(n,t)?a=!0:function(t,e){w(t,e,NodeFilter.SHOW_ELEMENT)}(e,e=>(e===s&&(i=!0),i&&B(e,t)?(a=!0,null):e===n?null:void 0)),a}getSelectionCommonNode(){const t=this.getRange();return null===t?null:t.commonAncestorContainer}getSelectionCommonElement(){const t=this.getSelectionCommonNode();return null===t?null:y(t)}getSelectionStartNode(){const t=this.getRange();return null===t?null:t.startContainer}getSelectionEndNode(){const t=this.getRange();return null===t?null:t.endContainer}getSelectionStartElement(){const t=this.getSelectionStartNode();return null===t?null:y(t)}getSelectionEndElement(){const t=this.getSelectionEndNode();return null===t?null:y(t)}whichOfTheseTypesSelectionBelongsTo(t){var e=this.getRange();return null===e?[]:function(t,e=[]){return e.reduce((e,s)=>(B(t,s)&&e.push(s),e),[])}(e.commonAncestorContainer,t)}getSelectionRect(){let t=this.getRange();if(null===t)return null;{let e=t.getBoundingClientRect();0===e.left&&(t=t.cloneRange(),t.setStart(t.startContainer,0),e=t.getBoundingClientRect());const s=n.rect(this.$dom.main);return{left:e.left-s.left,top:e.top-s.top,width:e.width,height:e.height,bottom:s.bottom-e.bottom}}}isNodeBelongsToMe(t){return this.$dom.parent.isSameNode(t)||this.$dom.parent.contains(t)}isCurrentSelectionMine(){return this.isNodeBelongsToMe(this.getSelectionCommonElement())}handleSelectionChange(t){if(this.isCurrentSelectionMine()){const e=this.getSelectionRect();null!==e&&this.callEvent("selectionChanged",this.isSelectionCollapsed(),e,t)}else this.callEvent("unselected")}handleMouseDown(t){if(this.isNodeBelongsToMe(t.target))return this.callEvent("mousedown",t);this.callEvent("unselected")}handleMouseUp(t){if(this.isNodeBelongsToMe(t.target))return this.callEvent("mouseup",t);this.callEvent("unselected")}createRange(){return this.getDocument().createRange()}placeCaretAtNodeEdge(t,e=!1){const s=this.createRange();s.selectNodeContents(t),s.collapse(e);const n=this.getSelection();n.removeAllRanges(),n.addRange(s)}displaceCaret(){this.$dom.main.blur()}placeCaretOutOfNodeEdge(t,e=!1){const s=this.createRange();e?s.setStartBefore(t):s.setStartAfter(t),s.collapse(e);const n=this.getSelection();n.removeAllRanges(),n.addRange(s)}selectNode(t){const e=this.getSelection();null!==e&&e.setBaseAndExtent(t,0,t,1)}selectNodes(t){const e=this.getSelection();null!==e&&(e.removeAllRanges(),t.forEach(t=>{const s=this.createRange();s.selectNodeContents(t),e.addRange(s)}))}placeCaretAtEdge(t=!1){this.placeCaretAtNodeEdge(this.$dom.main,t)}getTextBeforeSelectionInNode(){const t=this.getRangeBeforeSelectionInNode();return null===t?null:t.toString()}getRangeBeforeSelectionInNode(){const t=this.getRange();if(null===t)return null;{const e=t.cloneRange();return e.collapse(!0),e.setStart(t.startContainer,0),e}}getRangeAfterSelectionInNode(){const t=this.getRange();if(null===t)return null;{const e=t.cloneRange();return e.collapse(!1),e.setEndAfter(t.endContainer),e}}getRangeBeforeSelection(){var t=this.getRange();if(null===t)return null;{const e=t.cloneRange();return e.collapse(!0),e.setStart(this.$dom.main,0),e}}getTextBeforeSelection(){const t=this.getRangeBeforeSelection();return null===t?null:t.toString()}getCharBeforeSelection(t=1){const e=this.getTextBeforeSelection();if(null===e)return null;{const s=e.length;return 0===s?null:e.substr(-1*Math.min(t,s))}}getRangeAfterSelection(){const t=this.getRange();if(null===t)return null;{const e=t.cloneRange();return e.collapse(!1),this.$dom.main.lastChild&&e.setEndAfter(this.$dom.main.lastChild),e}}getTextAfterSelection(){const t=this.getRangeAfterSelection();return null===t?null:t.toString()}getCharAfterSelection(t=1){const e=this.getTextAfterSelection();if(null===e)return null;{const s=e.length;return 0===s?null:e.substr(0,Math.min(t,s))}}isSelectionAtTheBeginning(){return null===this.getCharBeforeSelection()}isSelectionAtTheEnd(){return null===this.getCharAfterSelection()}isCaretAtTheBeginning(){return this.isSelectionCollapsed()&&this.isSelectionAtTheBeginning()}isCaretAtTheEnd(){return this.isSelectionCollapsed()&&this.isSelectionAtTheEnd()}getHtmlBeforeAndAfterSelection(){return{before:A(this.getRangeBeforeSelection()),after:A(this.getRangeAfterSelection())}}saveSelection(){const t=this.getRange();null!==t&&(this.saved_selection={$start_node:this.getSelectionStartNode(),$end_node:this.getSelectionEndNode(),start_offset:t.startOffset,end_offset:t.endOffset})}restoreSelection(){if(null!==this.saved_selection){const t=this.getSelection();if(null!==t){const e=this.createRange();e.setStart(this.saved_selection.$start_node,this.saved_selection.start_offset),e.setEnd(this.saved_selection.$end_node,this.saved_selection.end_offset),t.removeAllRanges(),t.addRange(e)}}}selectAll(){const t=this.createRange();t.selectNodeContents(this.$dom.main);const e=this.getSelection();e.removeAllRanges(),e.addRange(t)}}var U=s(713);class F extends h.a{constructor(t,{events:e}){super(e),this.$dom={parent:t,main:n.parseHTML(this.getStructureHtml()),items:[]},n.delegateEvent(this.$dom.main,".herzen__command_list__item","mousedown",(t,e)=>this.handleItemClick(t,e)),n.append(t,this.$dom.main),this.is_open=!1,this.selectedIndex=0}destroy(){n.off(this.$dom.main),n.remove(this.$dom.main),this.$dom=Object(g.a)(this.$dom)}getStructureHtml(){return'<div class="herzen__command_list"></div>'}show(t,e,s){if(this.is_open=t&&t.length>0,this.is_open){const i=s.left+s.width/2,a=s.top+22;n.css(this.$dom.main,{left:i+"px",top:a+"px"}),n.html(this.$dom.main,t.map(t=>this.renderItem(t,e)).join("")),this.$dom.items=n.bem.findAll(this.$dom.main,"item"),this.selectItem(0)}else this.$dom.items=[];n.bem.toggle(this.$dom.main,"shown",this.is_open)}hide(){this.show(null)}renderItem(t,e){return`<div class="herzen__command_list__item" data-item="${encodeURIComponent(JSON.stringify(t))}">\n              ${e.renderInList(t)}\n          </div>`}selectItem(t){this.selectedIndex=t,this.$dom.items.forEach((e,s)=>n.bem.toggle(e,"selected",s===t))}moveSelection(t){this.selectItem(Object(U.a)(this.$dom.items.length,this.selectedIndex,t))}getSelectedItem(){const t=this.$dom.items[this.selectedIndex];return void 0===t?null:this.extractItemData(t)}isOpen(){return this.is_open}extractItemData(t){return JSON.parse(decodeURIComponent(n.data(t,"item")))}handleItemClick(t,e){t.preventDefault(),t.stopPropagation(),this.callEvent("itemPicked",this.extractItemData(e))}pickSelectedItem(){const t=this.getSelectedItem();null!==t&&this.callEvent("itemPicked",t)}}const z={};function j(t,e,s){(function(t){return void 0!==z[t]})(t)||function(t,e,s){z[t]=new RegExp(e,s)}(t,e,s)}function K(t,e){const s=function(t){const e=z[t];return void 0===e?null:e}(t);return null===s?null:s.exec(e)}function W(t){return t.split("").reverse().join("")}var J=s(15),X=s(3);let V=null,Y=null,q=null,G=null;const Q={},Z=new c.a(()=>function(){const t=V,e=Y,s=q,n=G;X.b({url:t,data:Object.assign({},e),success:i=>{!function(t,e,s){Q[tt(t,e)]=s}(t,e,i),n>=G&&s(i)}})}());function tt(t,e){return`${t}=>${JSON.stringify(e)}`}function et(t,e,s){const n=function(t,e){return Q[tt(t,e)]||null}(t,e);Z.reset(),null===n?(V=t,Y=e,q=s,G=Date.now(),Z.debounce(500)):s(n)}function st(t){return J.b("herzen_mentions_cache",!0)||[]}class nt extends h.a{constructor(t,{html:e="",json:s={},tools:n=[],commands:i=[],exporter:a=null,importer:o=null,preImporter:l=null,events:r}){super(r),this.commands=i,this.$dom=this.createStructure(t),this.CE=new M(this.$dom.main,{events:{selectionChanged:(t,e,s)=>{this.checkLastCommand(e)},keydown:t=>{this.handleKey_checkUndoRedo(t),!1!==this.handleKey_checkCommandList(t)&&(this.handleKey_checkIsInsideCommand(t),this.handleKey_checkBreak(t),this.handleKey_checkBackspace(t),this.handleKey_checkArrows(t),this.handleKey_checkSelection(t))},keyup:t=>{this.handleKey_checkLastCommand(t)},paste:t=>{this.handlePaste_checkPastedHtml(t),this.handlePaste_checkPastedFiles(t)},mousedown:t=>{this.handleMouseClick(!0)},mouseup:t=>{this.handleMouseClick(!1)},unselected:()=>{this.handleUnselected()},drop:t=>{this.handleDrop(t)},input:t=>{this.handleInput(t)},focus:(t,e)=>{this.handleFocus(e)}}}),this.commandTool=new F(this.$dom.main,{events:{itemPicked:t=>{this.pickCommandListItem(t)}}}),this.exporter=a,this.importer=o,this.preImporter=l,this.proxyMethods(this.CE,["setHtml","placeCaretAtEdge","joinHtml","saveSelection","restoreSelection","getText"]),this.importHtml(e)}destroy(){this.CE.destroy(),this.commandTool.destroy(),n.remove(this.$dom.main)}getStructureHtml(){return'<div class="herzen"></div>'}createStructure(t){const e={parent:t,main:null};return e.main=n.parseHTML(this.getStructureHtml()),n.append(e.parent,e.main),e}handleDrop(t){t.preventDefault(),t.dataTransfer&&t.dataTransfer.files&&t.dataTransfer.files.length>0&&this.callEvent("filesPasted",[...t.dataTransfer.files])}handleInput(t){this.callEvent("input",t)}handleMouseClick(t){}handleUnselected(){this.commandTool.hide()}handleFocus(t){this.callEvent("focus",t)}handleKey_checkUndoRedo(t){k.e(t)?(t.preventDefault(),this.callEvent("undo")):k.c(t)&&(t.preventDefault(),this.callEvent("redo"))}handleKey_checkIsInsideCommand(t){this.CE.isSelectionContainsType("command")&&k.b(t)&&(this.CE.saveSelection(),this.CE.breakSelectionTag("command"),this.CE.restoreSelection(),this.CE.normalizeTextNodes())}handleKey_checkCommandList(t){if(this.commandTool.isOpen()){if(k.a(t,"UP"))return this.commandTool.moveSelection(-1),t.preventDefault(),!1;if(k.a(t,"DOWN"))return this.commandTool.moveSelection(1),t.preventDefault(),!1;if(k.a(t,"ENTER"))return this.commandTool.pickSelectedItem(),t.preventDefault(),!1}}handleKey_checkBreak(t){k.a(t,"ENTER")&&(k.h(t)||k.g(t))&&(t.preventDefault(),this.callEvent("metaEnter"))}handleKey_checkBackspace(t){}handleKey_checkArrows(t){}handleKey_checkSelection(t){}handleKey_checkLastCommand(t){k.b(t)&&this.checkLastCommand(this.CE.getSelectionRect())}checkLastCommand(t){if(this.CE.isSelectionContainsType("command"))this.commandTool.hide();else{const e=this.parseLastCommand();null!==e?e.command.getItems(e.value).then(s=>{this.commandTool.show(s,e.command,t)}):this.commandTool.hide()}}parseLastCommand(){return function(t,e){let s=null;return t.some(t=>{const n="command_"+t.name;j(n,`^([${t.allowedSymbols}]{${void 0!==t.minLength?t.minLength:1},})(${t.initiator})(?!\\S)`,"i");const i=K(n,W(e));if(null!==i){const n=W(i[1]),a=W(i[2]),o=e.length,l=i[0].length;return s={command:t,value:n,start_index:o-l,end_index:o-l+a.length+n.length},!0}}),s}(this.commands,this.CE.getTextBeforeSelectionInNode())}pickCommandListItem(t){const e=this.parseLastCommand(),s=this.CE.getSelectionStartNode();if(this.commandTool.hide(),null!==t&&null!==e&&null!==s){!function(t){let e=st();for(let s=e.length-1;s>=0;s--)e[s].id==t.id&&e.splice(s,1);e.unshift(t),e=e.slice(0,5),J.d("herzen_mentions_cache",e,!0)}(t),s.splitText(e.end_index),s.splitText(e.start_index),n.remove(s.nextSibling),t.command_name=e.command.name;const i=D(this.CE.makeTag("command",t,e.command.renderInline(t)));this.CE.placeCaretAtNodeEdge(i),this.CE.normalizeTextNodes()}else console.warn("class.Herzen -> pickCommandListItem: called with bad parameters",t,e,s)}exportHtml(){return this.CE.exportHtml(({type:t,text:e,data:s},n)=>null===t||null===this.exporter?null===e?n:e:this.exporter({type:t,data:s},n))}importHtml(t){return null!==this.preImporter&&(t=this.preImporter(t)),this.CE.importHtml(t,t=>{let e=null,s=null;if(t.nodeType!==Node.TEXT_NODE&&null!==this.importer){const n=this.importer(t);n&&(n.type&&(e=n.type),n.data&&(s=n.data))}let n=t.textContent;return null===e&&(n=i.escapeHTML(n)),{type:e,text:n,data:s}}),this}handlePaste_checkPastedHtml(t){t.preventDefault(),this.CE.isSelectionContainsType("command")&&(this.CE.saveSelection(),this.CE.breakSelectionTag("command"),this.CE.restoreSelection(),this.CE.normalizeTextNodes());const e=t.clipboardData.getData("text/plain");this.CE.pasteHtmlAtSelection(e)}handlePaste_checkPastedFiles(t){t.clipboardData&&t.clipboardData.files&&t.clipboardData.files.length>0&&(t.preventDefault(),this.callEvent("filesPasted",[...t.clipboardData.files]))}focus(t=!0){t?this.CE.placeCaretAtEdge():this.CE.displaceCaret()}selectText(){this.CE.selectAll()}}class it extends S{constructor(t,{html:e="",tools:s,commands:n,exporter:i,importer:a,preImporter:o}){super("text",t),this.herzen=new nt(this.$dom.main,{html:e,tools:s,commands:n,exporter:i,importer:a,preImporter:o,events:{metaEnter:()=>{this.callEvent("wantToSubmit",!1)},input:()=>{this.callEvent("textChanged",this.clearEmptyness(this.herzen.getText()))},undo:()=>{this.callEvent("wantToUndo")},redo:()=>{this.callEvent("wantToRedo")},filesPasted:t=>{this.callEvent("wantToPasteFiles",t)},focus:t=>{this.callEvent("focus",t)}}})}setHtml(t){this.herzen.setHtml(t)}focus(t){this.herzen.focus(t)}remove(){this.herzen.destroy(),super.remove()}getContent(){return Promise.resolve(this.clearEmptyness(this.herzen.exportHtml()))}}const at={user:{name:"user",initiator:"@",allowedSymbols:"a-zа-яА-Я0-9_-",minLength:0,getItems:t=>new Promise(e=>{var s,n;n=t=>e(t),(s=t).length<1?n(st()):et("/search-for-mentions",{q:s},t=>{n(t.map(({id:t,text:e,img:s})=>({id:t,value:e,img:s})))})}),renderInList:t=>`<img src="${r.formImageUrl(t.img,20)}" style="width: 20px; height: 20px;"><span>${i.escapeHTML(t.value)}</span>`,renderInline:t=>"@"+i.escapeHTML(t.value)}};var ot=s(798),lt=s(7);class rt extends h.a{constructor(t,{blocks:e=[],blocksOptions:s={},events:i={},submitTitle:a="Submit",placeholder:r="Write something..."}){super(i),this.authData=Air.get("module.auth_data"),this.modulePopup=Air.get("module.popup"),this.uid="MiniThesis_"+Object(l.a)(),this.BLOCKS_TYPES={TEXT:"text"},this.blocks=[],this.blocksOptions=s,this.$dom={},this.$dom.parent=t,this.$dom.main=n.parseHTML(this.getStructureHtml()),this.$dom.content=n.bem.find(this.$dom.main,"content"),this.$dom.attaches=n.bem.find(this.$dom.main,"attaches"),this.$dom.uploadFile=n.bem.find(this.$dom.main,"upload_file"),this.$dom.attachVideo=n.bem.find(this.$dom.main,"attach_video"),this.$dom.submit=n.bem.find(this.$dom.main,"submit"),this.$dom.uploaded=n.bem.find(this.$dom.main,"uploaded"),this.$dom.user=n.bem.find(this.$dom.main,"user"),this.$dom.userAvatar=n.bem.find(this.$dom.main,"user_avatar"),this.$dom.placeholder=n.bem.find(this.$dom.main,"placeholder"),this.$dom.customButtons=n.bem.find(this.$dom.main,"custom_buttons"),this.$dom.form=this.$dom.parent.closest(".comments_form"),n.on(this.$dom.uploadFile,"click",this.uploadFiles.bind(this)),n.on(this.$dom.attachVideo,"click",this.attachVideo.bind(this)),n.on(this.$dom.submit,"click",this.submit.bind(this)),n.delegateEvent(this.$dom.main,".thesis__custom_button","click",(t,e)=>this.handleCustomButton(e)),n.append(this.$dom.parent,this.$dom.main),this.andropovUploaderPanel=new v(this.$dom.uploaded,{limit:2,events:{wait:t=>{this.wait(t)},change:(t,e)=>{this.callEvent("attachChanged",e)}}}),this.possessedUserInstance=null,this.timeMachine=new u({getter:()=>this.getBlocksData(),setter:t=>{this.removeAllBlocks(),this.addBlocksFromArray(t),this.checkBlocksAfterChanging()}}),this.moduleDom=new o.a,this.moduleDom.on("comments_attach_service",t=>{this.andropovUploaderPanel.parseText(n.val(t.el))&&this.modulePopup.hide()}),this.addBlocksFromArray(e),this.setSubmitTitle({text:a}),this.setPlaceholder(r),this.grammarlyBlocker=new ot.a(this.$dom.main,!0)}destroy(){this.grammarlyBlocker&&(this.grammarlyBlocker.destroy(),this.grammarlyBlocker=null),this.removeAllBlocks(),this.moduleDom.off(),this.timeMachine.destroy(),this.possessedUserInstance&&this.possessedUserInstance.destroy(),this.andropovUploaderPanel.destroy(),n.off(this.$dom.uploadFile),n.off(this.$dom.submit),n.off(this.$dom.main),n.off(document,this.uid),this.$dom=null}addBlocksFromArray(t=[]){t.map(({type:t,content:e})=>this.createBlock(t,e)).filter(t=>this.isBlockValid(t)).forEach(t=>this.appendBlock(t)),this.checkBlocksAfterChanging()}handleCustomButton(t){const e=n.data(t,"name");e?this.callEvent(e,{}):console.warn(`class.MiniThesis -> handleCustomButton: invalid button name "${e}"`)}checkPlaceholder(){this.getText().then(t=>{n.bem.toggle(this.$dom.main,"empty",0===t.length)})}checkBlocksAfterChanging(){0===this.getLength()&&this.appendBlock(this.createBlock(this.BLOCKS_TYPES.TEXT)),this.checkPlaceholder(),this.timeMachine.snap(300)}getStructureHtml(){return`<div class="thesis">\n                <div class="thesis__placeholder"></div>\n                <div class="thesis__content"></div>\n                <div class="thesis__uploaded"></div>\n                <div class="thesis__panel">\n                  <div class="thesis__attaches">\n                    <div class="thesis__upload_file thesis__attach_something">\n                      ${n.svgHtml("v_image",20)}\n                    </div>\n                    <div class="thesis__attach_video thesis__attach_something">\n                      ${n.svgHtml("v_link",20)}\n                    </div>\n                    ${n.preloaderHtml()}\n                  </div>\n                  <div class="thesis__custom_buttons"></div>\n                  <div class="thesis__user" data-ignore-outside-click>\n                      <img class="thesis__user_avatar"/>\n                  </div>\n                  <div class="thesis__submit v-button v-button--size-default v-button--blue"></div>\n                </div>\n            </div>`}setSubmitTitle({text:t,icon:e,isShort:s}){let i=`<span class="v-button__label">${t}</span>`;e&&s&&lt.g&&(i=`<div class="v-button__icon v-button__icon--new">${n.svgHtml(e,24,24)}</div>`),n.html(this.$dom.submit,i)}setSubmitState(t){n.toggleClass(this.$dom.submit,"v-button--disabled",t)}setPlaceholder(t){n.text(this.$dom.placeholder,t)}uploadFiles(){r.callFileUploader({limit:2}).then(t=>{this.andropovUploaderPanel.addFiles(t),this.setFocus(!0)})}attachVideo(){this.modulePopup.show({template:"attach_service",data:{i18n:{attachVideoOrLink:Object(a.c)("Attach a video or link"),link:Object(a.c)("Link")}}})}getLength(t=null){return null===t?this.blocks.length:this.blocks.reduce((e,s)=>(s.isType(t)&&e++,e),0)}isBlockValid(t){return null!==t}getBlockOptionsForType(t){return void 0===this.blocksOptions[t]?{}:this.blocksOptions[t]}createBlock(t,e){const s=this.getBlockOptionsForType(t);switch(t){case this.BLOCKS_TYPES.TEXT:return this.createTextBlock({html:e},s);default:return console.warn(`class.MiniThesis -> createBlock: unknown type "${t}"`),null}}createTextBlock({html:t},{exporter:e,importer:s,preImporter:n}){return t&&(t=i.escapeHTML(t)),new it({events:{textChanged:(t,e)=>{this.checkPlaceholder(),this.parseLinks(),this.timeMachine.snap(300),this.callEvent("textChanged",e)},wantToSubmit:t=>{this.submit()},wantToUndo:t=>{this.timeMachine.back()&&this.setFocus(),this.callEvent("undo")},wantToRedo:t=>{this.timeMachine.forward()&&this.setFocus(),this.callEvent("redo")},wantToPasteFiles:(t,e)=>{this.andropovUploaderPanel.addFiles(e)},focus:(t,e)=>{this.callEvent("focus",{state:e})}}},{html:t,commands:[at.user],exporter:e,importer:s,preImporter:n})}parseLinks(){this.getAllData().then(({blocksData:t})=>{this.andropovUploaderPanel.parseTextDebounce(t[0].content,1e3)})}getPreviousIndex(t,e=null){const s=this.getBlockIndex(t);if(null===s)return null;for(let t=Math.min(s,this.getLastIndex()+1)-1;t>=0;t--)if(null===e||this.blocks[t].isType(e))return t;return null}getBlockByIndex(t){return null===t?null:this.blocks[t]}getPreviousBlock(t,e){return this.getBlockByIndex(this.getPreviousIndex(t,e))}getNextIndex(t,e){const s=this.getBlockIndex(t);if(null===s)return null;for(let t=Math.min(s,this.getLastIndex())+1;t<this.getLength();t++)if(null===e||this.blocks[t].isType(e))return t;return null}getNextBlock(t,e){return this.getBlockByIndex(this.getNextIndex(t,e))}getLastIndex(t=null){if(null===t)return this.getLength()-1;for(let e=this.getLength()-1;e>=0;e--)if(this.blocks[e].isType(t))return e;return null}getLastBlock(t){return this.getBlockByIndex(this.getLastIndex(t))}getBlockIndex(t){return this.getBlockAndIndex(t).index}getBlock(t){return this.getBlockAndIndex(t).block}getBlockAndIndex(t){let e=null,s=null;return this.blocks.some((n,i)=>{if(n.isUid(t))return e=n,s=i,!0}),{block:e,index:s}}insertBlockAfter(t,e){let{block:s,index:n}=this.getBlockAndIndex(t);null===s&&(s=this.getLastBlock(),n=this.getLastIndex()),null===s?this.appendBlock(e):(e.insertAfter(s.getElement()),this.blocks.splice(n+1,0,e),this.checkBlocksAfterChanging())}appendBlock(t){return t.appendTo(this.$dom.content),this.blocks.push(t),this.checkBlocksAfterChanging(),t}removeBlock(t){const{block:e,index:s}=this.getBlockAndIndex(t);this.blocks.splice(s,1),this.checkBlocksAfterChanging(),e.remove()}removeAllBlocks(){this.blocks.forEach(t=>t.remove()),this.blocks=[]}getBlocksData(){return Promise.all(this.blocks.map(t=>t.getData()))}getText(t=""){return this.getBlocksData().then(e=>e.filter(t=>t.type===this.BLOCKS_TYPES.TEXT).map(t=>t.content).join(t))}setText(t="",e=null){this.removeAllBlocks();const s=null===e?[t]:t.split(e);this.addBlocksFromArray(s.map(t=>({type:this.BLOCKS_TYPES.TEXT,content:t})))}setMedia(t=[]){this.andropovUploaderPanel.addItems(t)}getAttachedData(){return this.andropovUploaderPanel.getData()}getAllData(){return Promise.all([this.getBlocksData(),this.getAttachedData()]).then(([t,e])=>({blocksData:t,attachedData:e}))}wait(t){n.bem.toggle(this.$dom.main,"wait",t)}disable(t){n.bem.toggle(this.$dom.main,"disabled",t)}setUserData(t){r.setImgSrc(this.$dom.userAvatar,t.avatar_url),null===this.possessedUserInstance&&this.authData.isPossessionAvailable()&&this.authData.isUser()&&(this.possessedUserInstance=new _({container:this.$dom.user,url:"/auth/possess/get"}),this.possessedUserInstance.on("change",t=>{this.callEvent("possessionChanged",{id:t.id,avatar_url:t.img})})),n.bem.add(this.$dom.user,"user_logged_in")}submit(){this.wait(!0),this.disable(!0),this.getAllData().then(({blocksData:t,attachedData:e})=>{this.wait(!1),this.disable(!1),this.callEvent("submit",{blocksData:t,attachedData:e})})}clear(){this.removeAllBlocks(),this.checkBlocksAfterChanging(),this.andropovUploaderPanel.clear()}setFocus(t=!0){if(t){const t=this.getLastBlock(this.BLOCKS_TYPES.TEXT);null!==t&&t.focus(!0)}else this.blocks.forEach(t=>t.focus(!1))}addCustomButton({name:t,label:e},s=!1){s&&this.removeCustomButtons();const i=n.parseHTML(`<div class="thesis__custom_button" data-name="${t}">${e}</div>`);n.append(this.$dom.customButtons,i)}removeCustomButtons(){n.html(this.$dom.customButtons,"")}}},550:function(t,e,s){"use strict";var n=s(43);function i(t){return"object"==typeof t&&null!=t&&Array.isArray(Object.keys(t))}e.a=function(t){return"string"==typeof t?Object(n.a)(t):i(t)?Object(n.a)(JSON.stringify(function t(e){return Object.keys(e).sort().reduce((s,n)=>{const a=e[n];return s[n]=i(a)?t(a):a,s},{})}(t))):Object(n.a)(JSON.stringify(t))}},587:function(t,e,s){"use strict";s.d(e,"a",(function(){return l}));var n=s(42),i=s(0),a=s(9),o=s(8);class l{constructor(t){this.andropov_data=t}getImageData(){switch(this.andropov_data.type){case"image":case"movie":return this.andropov_data.data;case"video":return this.andropov_data.data.thumbnail.data;case"link":return this.andropov_data.data.image.data;case"universalbox":switch(this.andropov_data.data.service){case"instagram":return this.andropov_data.data.box_data.image?this.andropov_data.data.box_data.image.data:null;default:return null}case"tweet":return{uuid:this.andropov_data.data.tweet_data.user.profile_image_url_https,color:this.andropov_data.data.tweet_data.user.profile_background_color,size:1};case"telegram":return{uuid:this.andropov_data.data.tg_data.author.avatar_url,size:1};default:return null}}getTitle(){switch(this.andropov_data.type){case"link":return this.andropov_data.data.title||this.getHostname();case"universalbox":switch(this.andropov_data.data.service){case"instagram":case"tiktok":case"spotify":return this.andropov_data.data.box_data.title||this.getHostname();default:return null}case"tweet":return this.andropov_data.data.tweet_data.user.name;case"telegram":return this.andropov_data.data.tg_data.author.name;default:return null}}getDescription(){switch(this.andropov_data.type){case"link":return this.andropov_data.data.description||this.getUrl();case"universalbox":switch(this.andropov_data.data.service){case"instagram":case"tiktok":case"spotify":return this.andropov_data.data.box_data.url||this.getUrl();default:return null}case"tweet":return this.andropov_data.data.tweet_data.user.description;case"telegram":return this.getUrl();default:return null}}getUrl(){switch(this.andropov_data.type){case"link":return this.andropov_data.data.url;case"universalbox":switch(this.andropov_data.data.service){case"instagram":case"tiktok":case"spotify":return this.andropov_data.data.box_data.url;default:return null}case"tweet":return"https://twitter.com";case"telegram":return"https://telegram.org/";default:return null}}getHostname(){return Object(n.a)(this.getUrl()).hostname}getImageUrl(t,e,s){return this.hasImage()?a.formImageUrl(this.getImageData().uuid,t,e,s):null}getImageOriginalUrl(){return this.hasImage()?`${a.getCdnUrl()}/${this.getImageData().uuid}`:null}hasImage(){const t=this.getImageData();return!(null===t||!t.uuid)}getColor(){var t=this.getImageData();return null!==t&&t.color?"#"+t.color:null}getData(){return this.andropov_data}toString(){return JSON.stringify(this.getData())}getType(){return this.getData().type}typeIs(t){return this.getType()===t}getPreviewHtml(t){const e="andropov_preview",s=[e,`${e}--${this.andropov_data.type}`];let n="";const a=`width: ${t.size}px; height: ${t.size}px;`;switch(this.andropov_data.type){case"image":n=`<img class="${e}__image" style="max-width: ${t.size}px; max-height: ${t.size}px;" src="${this.getImageUrl(t.size,t.size,"preview")}">`;break;case"movie":case"video":n=`<img class="${e}__image" style="${a}" src="${this.getImageUrl(t.size)}">${i.svgHtml("andropov_play_default",44)}`;break;case"universalbox":case"link":case"tweet":case"telegram":n=`<div class="${e}__info ${this.hasImage(),e+"__info--without_image"}">\n                        <div class="${e}__title">${Object(o.escapeHTML)(this.getTitle())}</div>\n                        <div class="${e}__description">${Object(o.escapeHTML)(this.getDescription())}</div>\n                        <div class="${e}__hostname">${Object(o.escapeHTML)(this.getHostname())}</div>\n                    </div>`,this.hasImage()}return`<div class="${s.join(" ")}" style="min-height: ${t.size}px; min-width: ${t.size}px">${n}</div>`}}},713:function(t,e,s){"use strict";e.a=function(t,e,s,n){let i;for(null===e?s>0?i=s-1:s<0&&(i=t+s):i=e+s;i>t;)i-=t+1;for(;i<-1;)i+=t+1;return!0===n?-1!==i&&i!==t||(i=null):-1===i?i=t-1:i===t&&(i=0),i}},798:function(t,e,s){"use strict";s.d(e,"a",(function(){return n}));class n{constructor(t,e=!1){this.container=null,this.observer=null,this.processedElements=null,this.isEnableObserver=e,this.isGrammarlyEnabled=document.body.hasAttribute("data-gr-ext-installed")||document.body.hasAttribute("data-new-gr-c-s-loaded"),this.isGrammarlyEnabled&&(this.container=t,this.processedElements=new Set,this.init(),this.isEnableObserver&&this.observe())}init(){const t=[...this.container.querySelectorAll("textarea, [contenteditable=true]")];t.length&&t.forEach(this.processElement.bind(this))}observe(){this.observer=new MutationObserver(this.observerHandler.bind(this)),this.observer.observe(this.container,{childList:!0,subtree:!0})}observerHandler(t){t.reduce((t,e)=>{const{target:s}=e;return[...s.querySelectorAll("textarea, [contenteditable=true]")].forEach(e=>{this.processedElements.has(e)||t.add(e)}),t},new Set).forEach(this.processElement.bind(this))}destroy(){this.observer&&(this.observer.disconnect(),this.observer=null),this.container=null,this.processedElements=null}processElement(t){n.setGrammarlyOff(t),this.processedElements.add(t)}static setGrammarlyOff(t){t.dataset.gramm=!1}}}}]);